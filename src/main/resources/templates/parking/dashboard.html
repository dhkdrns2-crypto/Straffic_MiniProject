<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ì°¨ ê´€ë¦¬ - STRAFFIC</title>
    <link rel="stylesheet" th:href="@{/css/parking-dashboard.css}">
</head>
<body>

<div layout:fragment="content">
    <div class="dashboard-container">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--primary-light); color: var(--primary);">
                    P
                </div>
                <div class="stat-content">
                    <h3>ì „ì²´ ì£¼ì°¨ë©´</h3>
                    <div class="value">10ë©´</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #dcfce7; color: var(--success);">
                    ğŸš—
                </div>
                <div class="stat-content">
                    <h3>í˜„ì¬ ì£¼ì°¨ì¤‘</h3>
                    <div class="value" id="occupiedCount">0ëŒ€</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fee2e2; color: var(--danger);">
                    âš¡
                </div>
                <div class="stat-content">
                    <h3>ì”ì—¬ ì£¼ì°¨ë©´</h3>
                    <div class="value" id="availableCount">10ë©´</div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Parking Lot View -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">
                        <span>ì‹¤ì‹œê°„ ì£¼ì°¨ í˜„í™©</span>
                        <span style="font-size: 12px; font-weight: 500; color: var(--success); background: #dcfce7; padding: 4px 8px; border-radius: 20px;">Live</span>
                    </div>
                </div>
                <div class="parking-lot" id="parkingLot">
                    <!-- Spots generated by JS -->
                </div>
            </div>

            <!-- Control Panel -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title">ì…ì°¨ / ì¶œì°¨ ê´€ë¦¬</div>
                </div>

                <!-- OCR Upload -->
                <div class="image-upload" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“·</div>
                    <div style="font-weight: 600; color: var(--gray-700);">ì°¨ëŸ‰ ë²ˆí˜¸íŒ ì¸ì‹</div>
                    <div style="font-size: 13px; color: var(--gray-500);">í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì—…ë¡œë“œ</div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFile(this.files[0])">

                <div id="previewContainer" class="preview-container">
                    <img id="previewImg" class="preview-img">
                </div>

                <div id="ocrResult" class="ocr-result"></div>

                <div class="form-group">
                    <label class="form-label">ì°¨ëŸ‰ë²ˆí˜¸</label>
                    <input type="text" id="plateNumber" class="form-input" placeholder="12ê°€ 3456">
                </div>

                <div class="form-group">
                    <label class="form-label">êµ¬ì—­ ì„ íƒ</label>
                    <select id="spotSelect" class="form-input">
                        <option value="">êµ¬ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="handleEntry()">ì…ì°¨ ë“±ë¡</button>
            </div>
        </div>
    </div>

    <!-- Exit Modal -->
    <div id="exitModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">ì¶œì°¨ ì •ì‚°</div>
            
            <div class="info-row">
                <span class="info-label">ì°¨ëŸ‰ë²ˆí˜¸</span>
                <span class="info-value" id="modalPlate"></span>
            </div>
            <div class="info-row">
                <span class="info-label">ì…ì°¨ì‹œê°„</span>
                <span class="info-value" id="modalEntryTime"></span>
            </div>
            <div class="info-row">
                <span class="info-label">ì£¼ì°¨ì‹œê°„</span>
                <span class="info-value" id="modalDuration"></span>
            </div>

            <div class="price-total">
                <span class="info-label">ê²°ì œê¸ˆì•¡</span>
                <span class="price-value" id="modalFee"></span>
            </div>

            <button class="btn btn-primary" style="margin-top: 20px; background: var(--gray-900);" onclick="confirmExit()">ì •ì‚° ë° ì¶œì°¨</button>
            <button class="btn" style="margin-top: 10px; background: var(--gray-100); color: var(--gray-600);" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>

<script>
    const TOTAL_SPOTS = 10;
    let selectedSpot = null;
    let parkingData = {};

    // Initialize
    async function init() {
        const grid = document.getElementById('parkingLot');
        const select = document.getElementById('spotSelect');

        for(let i=1; i<=TOTAL_SPOTS; i++) {
            const spotId = `A-${i}`;
            
            // Grid Item
            const spot = document.createElement('div');
            spot.className = 'parking-spot';
            spot.id = `spot-${spotId}`;
            spot.innerHTML = `<span class="spot-number">${spotId}</span>`;
            spot.onclick = () => handleSpotClick(spotId);
            grid.appendChild(spot);

            // Select Option
            const option = document.createElement('option');
            option.value = spotId;
            option.text = spotId;
            select.appendChild(option);
        }
        
        // Load initial data
        await loadStatus();
    }

    async function loadStatus() {
        try {
            const res = await fetch('/api/parking/status');
            const data = await res.json();
            
            if(data.success && data.spots) {
                parkingData = {};
                Object.values(data.spots).forEach(spot => {
                    if(spot.occupied) {
                        parkingData[spot.spotId] = {
                            plate: spot.plateNumber,
                            entryTime: new Date(spot.entryTime)
                        };
                        updateSpotUI(spot.spotId);
                    }
                });
                updateStats();
            }
        } catch(e) {
            console.error("Failed to load status:", e);
        }
    }

    // Handle File Upload & OCR
    async function handleFile(file) {
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('previewContainer').classList.add('show');
        };
        reader.readAsDataURL(file);

        const ocrResult = document.getElementById('ocrResult');
        ocrResult.className = 'ocr-result show';
        ocrResult.innerHTML = '<div class="loading-spinner"><div class="spinner"></div> ë²ˆí˜¸íŒ ì¸ì‹ ì¤‘...</div>';

        try {
            const formData = new FormData();
            formData.append('image', file);

            // Assuming Flask OCR server is running on localhost:5000
            // If not, this will fail gracefully
            const response = await fetch('http://localhost:5000/api/parking/recognize', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success && data.plates && data.plates.length > 0) {
                const plateNumber = data.plates[0].plate_number;
                ocrResult.className = 'ocr-result show';
                ocrResult.innerHTML = `
                    <div class="ocr-plate">${plateNumber}</div>
                    <div style="color: #15803d; margin-top: 6px; font-weight: 500;">ì¸ì‹ ì™„ë£Œ</div>
                `;
                document.getElementById('plateNumber').value = plateNumber;
            } else {
                ocrResult.className = 'ocr-result show';
                ocrResult.innerHTML = `
                    <div style="color: #dc2626; font-weight: 500;">ë²ˆí˜¸íŒì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                `;
            }
        } catch (error) {
            console.error(error);
            // Simulation for demo if server fails
            setTimeout(() => {
                const mockPlate = "12ê°€ " + Math.floor(1000 + Math.random() * 9000);
                ocrResult.className = 'ocr-result show';
                ocrResult.innerHTML = `
                    <div class="ocr-plate">${mockPlate}</div>
                    <div style="color: #15803d; margin-top: 6px; font-weight: 500;">ì¸ì‹ ì™„ë£Œ (Demo)</div>
                `;
                document.getElementById('plateNumber').value = mockPlate;
            }, 1000);
        }
    }

    function handleSpotClick(id) {
        if(parkingData[id]) {
            // Show Exit Modal
            selectedSpot = id;
            showExitModal(id);
        } else {
            // Select for Entry
            document.getElementById('spotSelect').value = id;
            document.getElementById('plateNumber').focus();
        }
    }

    async function handleEntry() {
        const plate = document.getElementById('plateNumber').value;
        const spotId = document.getElementById('spotSelect').value;

        if(!plate || !spotId) {
            alert('ì°¨ëŸ‰ë²ˆí˜¸ì™€ êµ¬ì—­ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if(parkingData[spotId]) {
            alert('ì´ë¯¸ ì£¼ì°¨ëœ êµ¬ì—­ì…ë‹ˆë‹¤.');
            return;
        }

        // API Call
        try {
            const res = await fetch('/api/parking/entry', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plateNumber: plate, spotId: spotId })
            });
            
            const data = await res.json();

            if(res.ok && data.success) {
                 // Update UI
                parkingData[spotId] = {
                    plate: plate,
                    entryTime: new Date()
                };
                updateSpotUI(spotId);
                updateStats();
                
                // Reset Form
                document.getElementById('plateNumber').value = '';
                document.getElementById('spotSelect').value = '';
                document.getElementById('previewContainer').classList.remove('show');
                document.getElementById('ocrResult').classList.remove('show');
                
                alert(data.message || "ì…ì°¨ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                alert(data.error || "ì…ì°¨ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch(e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
        }
    }

    function showExitModal(id) {
        const data = parkingData[id];
        if(!data) return;

        const now = new Date();
        const duration = Math.ceil((now - data.entryTime) / (1000 * 60)); // minutes
        const fee = Math.ceil(duration / 10) * 1000; // 1000 won per 10 min

        document.getElementById('modalPlate').textContent = data.plate;
        document.getElementById('modalEntryTime').textContent = data.entryTime.toLocaleTimeString();
        document.getElementById('modalDuration').textContent = `${duration}ë¶„`;
        document.getElementById('modalFee').textContent = `${fee.toLocaleString()}ì›`;
        
        document.getElementById('exitModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('exitModal').classList.remove('active');
        selectedSpot = null;
    }

    async function confirmExit() {
        if(!selectedSpot) return;
        
        try {
            const res = await fetch('/api/parking/exit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spotId: selectedSpot })
            });

            const data = await res.json();
            
            if(data.success) {
                delete parkingData[selectedSpot];
                updateSpotUI(selectedSpot);
                updateStats();
                closeModal();
                alert(`ì¶œì°¨ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nìš”ê¸ˆ: ${data.fee}ì›`);
            } else {
                alert(data.error || "ì¶œì°¨ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch(e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function updateSpotUI(id) {
        const el = document.getElementById(`spot-${id}`);
        if(parkingData[id]) {
            el.classList.add('occupied');
            el.innerHTML = `
                <span class="spot-number" style="color:var(--primary)">${parkingData[id].plate}</span>
            `;
        } else {
            el.classList.remove('occupied');
            el.innerHTML = `<span class="spot-number">${id}</span>`;
        }
    }

    function updateStats() {
        const occupied = Object.keys(parkingData).length;
        const available = TOTAL_SPOTS - occupied;
        
        document.getElementById('occupiedCount').textContent = `${occupied}ëŒ€`;
        document.getElementById('availableCount').textContent = `${available}ë©´`;
    }

    // Run Init
    init();
</script>
</div>
</body>
</html>